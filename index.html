<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EIP-7702 Wallet Upgrader</title>
</head>
<body>
  <h2>EIP-7702 ç­¾åç¤ºä¾‹</h2>

  <button id="connect">è¿æ¥é’±åŒ…</button>
  <button id="addPlasmaNetwork">â• æ·»åŠ  Plasma ç½‘ç»œ</button>
  <button id="addPlasmaAccount">ğŸ‘¤ æ·»åŠ  / åˆ‡æ¢ Plasma è´¦æˆ·</button>
  <button id="sign">ç­¾åå‡çº§ä¸º EIP-7702</button>

  <p id="status"></p>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.min.js";

    let provider;
    let signer;
    let address;

    const status = document.getElementById("status");

    /* ---------- è¿æ¥é’±åŒ… ---------- */
    document.getElementById("connect").onclick = async () => {
      if (!window.ethereum) {
        alert("è¯·ä½¿ç”¨æ”¯æŒ EIP-1193 çš„é’±åŒ…ï¼ˆMetaMask / imToken ç­‰ï¼‰");
        return;
      }

      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      address = await signer.getAddress();

      status.textContent = `é’±åŒ…å·²è¿æ¥: ${address}`;
    };

    /* ---------- æ·»åŠ  Plasma ç½‘ç»œ ---------- */
    document.getElementById("addPlasmaNetwork").onclick = async () => {
      if (!window.ethereum) {
        alert("æœªæ£€æµ‹åˆ°é’±åŒ…");
        return;
      }

      try {
        await window.ethereum.request({
          method: "wallet_addEthereumChain",
          params: [
            {
              chainId: "0xPLASMA", // âš ï¸ æ›¿æ¢ä¸ºçœŸå® Plasma chainIdï¼ˆ16è¿›åˆ¶ï¼‰
              chainName: "Plasma",
              rpcUrls: ["https://rpc.plasma.xyz"], // âš ï¸ ç¤ºä¾‹ RPC
              nativeCurrency: {
                name: "Plasma",
                symbol: "PLS",
                decimals: 18
              },
              blockExplorerUrls: ["https://explorer.plasma.xyz"] // âš ï¸ ç¤ºä¾‹
            }
          ]
        });

        status.textContent = "âœ… Plasma ç½‘ç»œå·²æ·»åŠ ï¼ˆæˆ–å·²å­˜åœ¨ï¼‰";
      } catch (err) {
        console.error(err);
        status.textContent = `âŒ æ·»åŠ  Plasma ç½‘ç»œå¤±è´¥: ${err.message}`;
      }
    };

    /* ---------- æ·»åŠ  / åˆ‡æ¢ Plasma è´¦æˆ· ---------- */
    document.getElementById("addPlasmaAccount").onclick = async () => {
      if (!window.ethereum) {
        alert("æœªæ£€æµ‹åˆ°é’±åŒ…");
        return;
      }

      try {
        /**
         * âš ï¸ é‡è¦è¯´æ˜ï¼š
         * EVM é’±åŒ…æ²¡æœ‰â€œä¸ºæŸæ¡é“¾å•ç‹¬åˆ›å»ºè´¦æˆ·â€çš„æ ‡å‡†æ¥å£
         * å®é™…åšæ³•æ˜¯ï¼š
         * 1. åˆ‡æ¢åˆ° Plasma ç½‘ç»œ
         * 2. è¯·æ±‚ accountsï¼ˆé’±åŒ…ä¼šè‡ªåŠ¨æ´¾ç”Ÿè¯¥é“¾ä¸‹è´¦æˆ·ï¼‰
         */

        // 1. åˆ‡æ¢åˆ° Plasma ç½‘ç»œ
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: "0xPLASMA" }] // âš ï¸ åŒä¸Š
        });

        // 2. è¯·æ±‚è´¦æˆ·ï¼ˆç¡®ä¿è¯¥é“¾ä¸‹è´¦æˆ·å¯ç”¨ï¼‰
        const accounts = await window.ethereum.request({
          method: "eth_requestAccounts"
        });

        status.textContent = `âœ… å·²åˆ‡æ¢åˆ° Plasma ç½‘ç»œï¼Œå½“å‰è´¦æˆ·: ${accounts[0]}`;
      } catch (err) {
        console.error(err);
        status.textContent = `âŒ åˆ‡æ¢ / æ·»åŠ  Plasma è´¦æˆ·å¤±è´¥: ${err.message}`;
      }
    };

    /* ---------- EIP-7702 ç¤ºä¾‹ç­¾å ---------- */
    document.getElementById("sign").onclick = async () => {
      if (!signer) {
        alert("è¯·å…ˆè¿æ¥é’±åŒ…");
        return;
      }

      const message = `Upgrade EOA ${address} to EIP-7702 contract address at ${new Date().toISOString()}`;
      const signature = await signer.signMessage(message);

      status.textContent = `ç­¾åæˆåŠŸ: ${signature}`;
      console.log("Signature:", signature);
    };
  </script>
</body>
</html>
