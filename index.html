<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wallet äº¤äº’</title>
</head>
<body>
  <h2>Wallet äº¤äº’æ“ä½œ</h2>

  <button id="connect">è¿æ¥é’±åŒ…</button>
  <button id="addPlasmaNetwork">â• æ·»åŠ  Plasma ç½‘ç»œ</button>
  <button id="addPlasmaAccount">ğŸ‘¤ æ·»åŠ  / åˆ‡æ¢ Plasma è´¦æˆ·</button>
  <input id="usdtTo" placeholder="æ”¶æ¬¾åœ°å€ 0x..." style="width:420px;" />
  <button id="sendUsdt">è½¬ 10 USDT</button>
<!--  <button id="sign">ç­¾åå‡çº§ä¸º EIP-7702</button>-->

  <p id="status"></p>

  <script type="module">
    // ethers js library
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.min.js";

    let provider;
    let signer;
    let address;
    
    // åœ¨é¡µé¢ä¸­è¾“å‡ºçŠ¶æ€
    const status = document.getElementById("status");
    
    // Plasma Info Params
    const PLASMA = {
      chainId: "0x2611",
      chainName: "Plasma",
      rpcUrls: ["https://plasma.drpc.org"],
      nativeCurrency: { name: "Plasma", symbol: "XPL", decimals: 18 },
      blockExplorerUrls: ["https://plasmascan.to"],
    };


    /* ---------- è¿æ¥é’±åŒ… ---------- */
    document.getElementById("connect").onclick = async () => {
      if (!window.ethereum) {
        alert("è¯·ä½¿ç”¨æ”¯æŒçš„é’±åŒ…ï¼ˆMetaMask / imToken ç­‰ï¼‰");
        return;
      }

      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      address = await signer.getAddress();

      status.textContent = `âœ… é’±åŒ…å·²è¿æ¥: ${address}`;
    };

    /* ---------- æ·»åŠ  Plasma ç½‘ç»œ ---------- */
    async function addPlasmaNetwork() {
      await window.ethereum.request({
        method: "wallet_addEthereumChain",
        params: [PLASMA],
      });
    }
    document.getElementById("addPlasmaNetwork").onclick = async () => {
        if (!window.ethereum) return alert("âš ï¸ æœªæ£€æµ‹åˆ°é’±åŒ…");
        try {
            await addPlasmaNetwork();
            status.textContent = "âœ… Plasma ç½‘ç»œå·²æ·»åŠ ï¼ˆæˆ–å·²å­˜åœ¨ï¼‰";
        } catch (err) {
            console.error(err);
            status.textContent = `âŒ æ·»åŠ  Plasma ç½‘ç»œå¤±è´¥: ${err?.message || String(err)}`;
        }
    };

    /* ---------- æ·»åŠ  / åˆ‡æ¢ Plasma è´¦æˆ· ---------- */
    async function switchToPlasma() {
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: PLASMA.chainId }],
      });
    }
    document.getElementById("addPlasmaAccount").onclick = async () => {
        if (!window.ethereum) return alert("âš ï¸ æœªæ£€æµ‹åˆ°é’±åŒ…");
          try {
            // å…ˆåˆ‡æ¢ï¼›å¦‚æœé’±åŒ…æç¤ºâ€œæœªæ·»åŠ è¯¥é“¾â€ï¼Œåˆ™è‡ªåŠ¨ add å† switch
            try {
              await switchToPlasma();
            } catch (e) {
              // MetaMask å¸¸è§ï¼š4902 = Unrecognized chain
              if (e?.code === 4902) {
                await addPlasmaNetwork();
                await switchToPlasma();
              } else {
                throw e;
              }
            }

            const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
            status.textContent = `âœ… å·²åˆ‡æ¢åˆ° Plasma ç½‘ç»œï¼Œå½“å‰è´¦æˆ·: ${accounts[0]}`;
          } catch (err) {
            console.error(err);
            status.textContent = `âŒ åˆ‡æ¢ / æ·»åŠ  Plasma è´¦æˆ·å¤±è´¥: ${err?.message || String(err)}`;
          }
    };
      
      // ====== USDT è½¬è´¦æŒ‰é’® ======
      document.getElementById("sendUsdt").onclick = async () => {
        try {
          if (!signer || !provider) {
            alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            return;
          }
          
          const toInput = document.getElementById("usdtTo");
          if (!toInput) {
            status.textContent = "âŒ é¡µé¢ç¼ºå°‘æ”¶æ¬¾åœ°å€è¾“å…¥æ¡†ï¼ˆid=usdtToï¼‰ã€‚è¯·ç¡®è®¤å·²æŠŠ <input id='usdtTo'> åŠ åˆ° HTML é‡Œã€‚";
            return;
          }

          const to = (toInput.value || "").trim();
          if (!ethers.isAddress(to)) {
            alert("æ”¶æ¬¾åœ°å€ä¸åˆæ³•");
            return;
          }

          const to = document.getElementById("usdtTo").value.trim();
          if (!ethers.isAddress(to)) {
            alert("æ”¶æ¬¾åœ°å€ä¸åˆæ³•");
            return;
          }

          // å¡«ã€Œå½“å‰é“¾ã€çš„ USDT åˆçº¦åœ°å€
          const USDT_ADDRESS = "0xdAC17F958D2ee523a2206206994597C13D831ec7";
          if (!ethers.isAddress(USDT_ADDRESS)) {
            alert("è¯·å…ˆå¡«å¥½ USDT åˆçº¦åœ°å€");
            return;
          }

          // ERC20 ABIï¼šåªç”¨åˆ° transfer / decimals / symbol
          const erc20Abi = [
            "function transfer(address to, uint256 amount) returns (bool)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)",
            "function balanceOf(address owner) view returns (uint256)",
          ];

          const usdt = new ethers.Contract(USDT_ADDRESS, erc20Abi, signer);

          // USDT é€šå¸¸ decimals=6ï¼Œä½†åˆ«ç¡¬ç¼–ç ï¼Œç›´æ¥è¯»åˆçº¦
          const [decimals, symbol, from] = await Promise.all([
            usdt.decimals(),
            usdt.symbol(),
            signer.getAddress(),
          ]);

          const amount = ethers.parseUnits("10", decimals);

          // å¯é€‰ï¼šè½¬è´¦å‰æ£€æŸ¥ä½™é¢ï¼Œé¿å…ç›´æ¥å¤±è´¥
          const bal = await usdt.balanceOf(from);
          if (bal < amount) {
            status.textContent = `âŒ ä½™é¢ä¸è¶³ï¼šå½“å‰ ${ethers.formatUnits(bal, decimals)} ${symbol}`;
            return;
          }

          status.textContent = `æ­£åœ¨å‘èµ·äº¤æ˜“ï¼šè½¬ 10 ${symbol} åˆ° ${to}â€¦`;

          // å‘äº¤æ˜“ï¼ˆä¼šå¼¹é’±åŒ…ç¡®è®¤ï¼‰
          const tx = await usdt.transfer(to, amount);

          status.textContent = `äº¤æ˜“å·²å‘é€ï¼š${tx.hash}ï¼ˆç­‰å¾…ç¡®è®¤â€¦ï¼‰`;
          const receipt = await tx.wait();

          status.textContent = receipt.status === 1
            ? `âœ… æˆåŠŸï¼šå·²è½¬å‡º 10 ${symbol}ï¼Œtx=${tx.hash}`
            : `âŒ å¤±è´¥ï¼štx=${tx.hash}`;
        } catch (err) {
          console.error(err);
          status.textContent = `âŒ è½¬è´¦å¤±è´¥: ${err?.shortMessage || err?.message || String(err)}`;
        }
      };
      
      
    /* ---------- EIP-7702 ç¤ºä¾‹ç­¾å ---------- */
    document.getElementById("sign").onclick = async () => {
      if (!signer) {
        alert("è¯·å…ˆè¿æ¥é’±åŒ…");
        return;
      }

      const message = `Upgrade EOA ${address} to EIP-7702 contract address at ${new Date().toISOString()}`;
      const signature = await signer.signMessage(message);

      status.textContent = `ç­¾åæˆåŠŸ: ${signature}`;
      console.log("Signature:", signature);
    };
  </script>
</body>
</html>
