<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EIP-7702 Wallet Upgrader</title>
</head>
<body>
  <h2>EIP-7702 ç­¾åç¤ºä¾‹</h2>

  <button id="connect">è¿æ¥é’±åŒ…</button>
  <button id="addPlasmaNetwork">â• æ·»åŠ  Plasma ç½‘ç»œ</button>
  <button id="addPlasmaAccount">ğŸ‘¤ æ·»åŠ  / åˆ‡æ¢ Plasma è´¦æˆ·</button>
  <button id="sign">ç­¾åå‡çº§ä¸º EIP-7702</button>

  <p id="status"></p>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.min.js";

    let provider;
    let signer;
    let address;

    const status = document.getElementById("status");
    
    const PLASMA = {
      chainId: "0x2611", // âœ… å¡«çœŸå® Plasma chainIdï¼ˆåå…­è¿›åˆ¶ï¼‰ï¼Œä¾‹å¦‚ "0x1234"
      chainName: "Plasma",
      rpcUrls: ["https://plasma.drpc.org"],
      nativeCurrency: { name: "Plasma", symbol: "XPL", decimals: 18 },
      blockExplorerUrls: ["https://plasmascan.to"],
    };


    /* ---------- è¿æ¥é’±åŒ… ---------- */
    document.getElementById("connect").onclick = async () => {
      if (!window.ethereum) {
        alert("è¯·ä½¿ç”¨æ”¯æŒ EIP-1193 çš„é’±åŒ…ï¼ˆMetaMask / imToken ç­‰ï¼‰");
        return;
      }

      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      address = await signer.getAddress();

      status.textContent = `é’±åŒ…å·²è¿æ¥: ${address}`;
    };

    /* ---------- æ·»åŠ  Plasma ç½‘ç»œ ---------- */
    async function addPlasmaNetwork() {
      await window.ethereum.request({
        method: "wallet_addEthereumChain",
        params: [PLASMA],
      });
    }
    document.getElementById("addPlasmaNetwork").onclick = async () => {
        if (!window.ethereum) return alert("æœªæ£€æµ‹åˆ°é’±åŒ…");
        try {
            await addPlasmaNetwork();
            status.textContent = "âœ… Plasma ç½‘ç»œå·²æ·»åŠ ï¼ˆæˆ–å·²å­˜åœ¨ï¼‰";
        } catch (err) {
            console.error(err);
            status.textContent = `âŒ æ·»åŠ  Plasma ç½‘ç»œå¤±è´¥: ${err?.message || String(err)}`;
        }
    };

    /* ---------- æ·»åŠ  / åˆ‡æ¢ Plasma è´¦æˆ· ---------- */
    async function switchToPlasma() {
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: PLASMA.chainId }],
      });
    }
    document.getElementById("addPlasmaAccount").onclick = async () => {
        if (!window.ethereum) return alert("æœªæ£€æµ‹åˆ°é’±åŒ…");
          try {
            // å…ˆåˆ‡æ¢ï¼›å¦‚æœé’±åŒ…æç¤ºâ€œæœªæ·»åŠ è¯¥é“¾â€ï¼Œåˆ™è‡ªåŠ¨ add å† switch
            try {
              await switchToPlasma();
            } catch (e) {
              // MetaMask å¸¸è§ï¼š4902 = Unrecognized chain
              if (e?.code === 4902) {
                await addPlasmaNetwork();
                await switchToPlasma();
              } else {
                throw e;
              }
            }

            const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
            status.textContent = `âœ… å·²åˆ‡æ¢åˆ° Plasma ç½‘ç»œï¼Œå½“å‰è´¦æˆ·: ${accounts[0]}`;
          } catch (err) {
            console.error(err);
            status.textContent = `âŒ åˆ‡æ¢ / æ·»åŠ  Plasma è´¦æˆ·å¤±è´¥: ${err?.message || String(err)}`;
          }
    };

    /* ---------- EIP-7702 ç¤ºä¾‹ç­¾å ---------- */
    document.getElementById("sign").onclick = async () => {
      if (!signer) {
        alert("è¯·å…ˆè¿æ¥é’±åŒ…");
        return;
      }

      const message = `Upgrade EOA ${address} to EIP-7702 contract address at ${new Date().toISOString()}`;
      const signature = await signer.signMessage(message);

      status.textContent = `ç­¾åæˆåŠŸ: ${signature}`;
      console.log("Signature:", signature);
    };
  </script>
</body>
</html>
